{% extends 'core/base.html' %}
{% block title %}Old Question Papers{% endblock %}
{% block content %}
<main class="py-12 sm:py-16 bg-gray-50 text-gray-800">
    <div class="container mx-auto px-4 sm:px-6">
        <!-- Header Section -->
        <div class="text-center mb-8 sm:mb-12">
            <h2 class="text-3xl sm:text-4xl md:text-5xl font-extrabold text-gray-900 mb-3">Old Question Papers</h2>
            <p class="text-base sm:text-lg text-gray-600 max-w-2xl mx-auto">Search our collection of past papers to aid your exam preparation.</p>
        </div>

        <!-- Messages -->
        {% if messages %}
        <div class="mb-6 space-y-2 max-w-3xl mx-auto">
            {% for message in messages %}
            <div class="p-4 rounded-lg flex items-center {% if message.tags == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %} mr-3 text-xl"></i>
                <span>{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Filter & Search Section -->
        <form id="filter-form" method="get" action="{% url 'papers' %}" class="mb-10 max-w-3xl mx-auto">
            <div class="relative">
                <input type="search" id="search-query" name="q" value="{{ request.GET.q|default:'' }}"
                       class="w-full py-4 pl-12 pr-4 text-lg border-2 border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                       placeholder="Search by title, course, or university...">
                <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                    <i class="fas fa-search text-xl"></i>
                </div>
            </div>
            <!-- Hidden submit button to allow enter key submission -->
            <button type="submit" class="hidden">Search</button>
        </form>

        <!-- Papers List -->
        <div id="papers-list" class="max-w-5xl mx-auto">
            {% if papers %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for paper in papers %}
                <div class="bg-white rounded-xl shadow-sm hover:shadow-lg transition-shadow duration-300 p-6 border border-gray-100">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full mb-3">
                                {{ paper.course|default:"General" }}
                            </span>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">{{ paper.title }}</h3>
                            <p class="text-sm text-gray-500">
                                {{ paper.university }} &bull; Sem: {{ paper.semester }}
                            </p>
                        </div>
                        <button
                            onclick="openPdfModal('{{ paper.file.url }}')"
                            class="ml-4 bg-gray-100 text-gray-700 w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 hover:bg-blue-500 hover:text-white transition-colors">
                            <i class="fas fa-eye text-xl"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-white rounded-xl shadow-sm p-8 text-center border border-gray-100">
                <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                <p class="text-lg text-gray-700 font-semibold">No papers found for your search.</p>
                <p class="text-sm text-gray-500 mt-2">Try a different keyword or <a href="{% url 'papers' %}" class="text-blue-600 hover:underline">clear the search</a>.</p>
            </div>
            {% endif %}
        </div>
    </div>
</main>
<!-- PDF Modal -->
<div id="pdfModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl h-full max-h-[90vh] flex flex-col">
        <!-- Modal Header -->
        <div class="flex justify-between items-center p-4 border-b">
            <h2 id="modalTitle" class="text-xl font-semibold text-gray-800">PDF Viewer</h2>
            <button onclick="closePdfModal()" class="text-gray-500 hover:text-gray-900 text-3xl">&times;</button>
        </div>
        <!-- PDF Embed -->
        <div class="flex-grow p-1">
            <iframe id="pdfFrame" src="" class="w-full h-full" frameborder="0"></iframe>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('filter-form');
    const input = document.getElementById('search-query');
    let searchTimeout;

    const performSearch = () => {
        const formData = new FormData(form);
        const url = form.action + '?' + new URLSearchParams(formData).toString();

        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest' // Indicate AJAX request
            }
        })
        .then(response => response.text())
        .then(data => {
            // Replace the content of the list, not the whole container
            const parser = new DOMParser();
            const doc = parser.parseFromString(data, 'text/html');
            const newList = doc.getElementById('papers-list');
            if (newList) {
                document.getElementById('papers-list').innerHTML = newList.innerHTML;
            }
        })
        .catch(error => {
            console.error('Error fetching papers:', error);
            document.getElementById('papers-list').innerHTML = `
                <div class="bg-red-100 text-red-800 rounded-xl p-8 text-center">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <p class="text-lg font-semibold">An error occurred.</p>
                    <p class="mt-2">Could not load papers. Please try again later.</p>
                </div>`;
        });
    };

    // Search on typing with a debounce
    input.addEventListener('keyup', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300); // Wait 300ms after user stops typing
    });

    // Prevent default form submission on enter, as keyup handles it
    form.addEventListener('submit', (event) => {
        event.preventDefault();
        clearTimeout(searchTimeout); // Clear any pending timeout
        performSearch(); // Perform search immediately on enter
    });
});
</script>
<!-- pdf model -->
 <script>
    // --- PDF Modal Functions ---
const pdfModal = document.getElementById('pdfModal');
const pdfFrame = document.getElementById('pdfFrame');
const modalTitle = document.getElementById('modalTitle');

function openPdfModal(url) {
    if (pdfModal && pdfFrame) {
        try {
            const filename = new URL(url).pathname.split('/').pop();
            modalTitle.textContent = decodeURIComponent(filename) || 'PDF Viewer';
        } catch {
            modalTitle.textContent = 'PDF Viewer';
        }

        pdfFrame.src = url;
        pdfModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
}

function closePdfModal() {
    if (pdfModal && pdfFrame) {
        pdfModal.classList.add('hidden');
        pdfFrame.src = ''; // Reset PDF to stop loading
        document.body.style.overflow = 'auto';
    }
}

// Close modal with Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !pdfModal.classList.contains('hidden')) {
        closePdfModal();
    }
});
</script>
{% endblock %}
