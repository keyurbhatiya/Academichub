{% extends 'core/base.html' %}
{% load static %}
{% block title %}Create Blog{% endblock %}
{% block content %}
<main class="py-12 bg-gray-100">
    <div class="container mx-auto px-4">
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Create a New Blog Post</h2>
            <p class="text-base text-gray-600 max-w-2xl">Share your insights with the AcademicHub community.</p>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 max-w-4xl mx-auto">
            <form method="post" enctype="multipart/form-data" class="space-y-6" id="blog-form">
                {% csrf_token %}
                {% for field in form %}
                <div class="flex flex-col">
                    <label for="{{ field.id_for_label }}" class="text-sm font-semibold text-gray-700 mb-2">
                        
                        {{ field.label }}{% if field.field.required %} <span class="text-red-500">*</span>{% endif %}
                    </label>
                    {% if field.name == 'content' %}
                        <div class="editor-container">
                            <div class="editor-toolbar">
                                <div class="editor-controls">
                                    <button type="button" id="toggle-html-btn" class="editor-btn">
                                        <i class="fas fa-code"></i> HTML View
                                    </button>
                                    <button type="button" id="insert-code-btn" class="editor-btn">
                                        <i class="fas fa-terminal"></i> Insert Code
                                    </button>
                                </div>
                                <span id="word-count" class="word-count">0 words</span>
                            </div>
                            <div id="quill-container" class="quill-container">
                                <div id="blog-content-editor"></div>
                            </div>
                            <div id="html-editor-container" class="hidden">
                                <textarea id="html-code-editor" class="html-editor" placeholder="Enter HTML..."></textarea>
                            </div>
                            <div id="html-preview-container" class="hidden">
                                <h4><i class="fas fa-eye"></i> Preview</h4>
                                <div id="html-preview" class="html-preview">
                                    <p style="color: #9ca3af; font-style: italic;">Preview will appear here...</p>
                                </div>
                            </div>
                            <input type="hidden" id="content" name="content" value="">
                            <div id="content-error" class="error-message hidden">
                                <i class="fas fa-exclamation-triangle"></i> Please enter blog content.
                            </div>
                        </div>
                    {% else %}
                        <input
                            type="{{ field.field.widget.input_type|default:'text' }}"
                            id="{{ field.id_for_label }}"
                            name="{{ field.name }}"
                            value="{{ field.value|default_if_none:'' }}"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-600 text-gray-700 text-base"
                            placeholder="{{ field.help_text|default:field.label }}"
                            {% if field.field.required %}required{% endif %}
                        />
                    {% endif %}
                    {% if field.errors %}
                        <div class="mt-2 text-sm text-red-600">
                            {% for error in field.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
                <div class="form-actions flex justify-between">
                    <a href="{% url 'blogs' %}" class="btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Blogs
                    </a>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-paper-plane"></i> Publish Blog
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>



<!-- Tailwind CSS -->
<style>
    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #667eea, #764ba2);
        min-height: 100vh;
    }

    .form-wrapper {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        max-width: 900px;
        margin: 0 auto;
    }

    .editor-toolbar {
        display: flex;
        justify-content: space-between;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .editor-btn {
        padding: 0.5rem 1rem;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .editor-btn:hover {
        background: #f3f4f6;
        transform: translateY(-1px);
    }

    .editor-btn.active {
        background: #4f46e5;
        color: white;
        border-color: #4f46e5;
    }

    .word-count {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .quill-container {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
    }

    .ql-editor {
        min-height: 300px;
        font-size: 1rem;
        padding: 1rem;
        background: white;
    }

    .html-editor {
        width: 100%;
        min-height: 300px;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-family: 'Fira Code', monospace;
        font-size: 0.9rem;
        background: #1e293b;
        color: #e2e8f0;
        resize: vertical;
    }

    .html-preview {
        margin-top: 1rem;
        padding: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #f8fafc;
        min-height: 150px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(79, 70, 229, 0.5);
    }

    .btn-secondary {
        color: #4f46e5;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .btn-secondary:hover {
        background: #f0f9ff;
    }

    .error-message {
        color: #ef4444;
        font-size: 0.875rem;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: #fef2f2;
        border-radius: 8px;
    }

    .hidden {
        display: none;
    }

    @media (max-width: 768px) {
        .editor-toolbar {
            flex-direction: column;
            gap: 0.75rem;
        }

        .form-actions {
            flex-direction: column;
            gap: 1rem;
        }

        .ql-editor {
            min-height: 200px;
        }
    }
</style>

<!-- quill editor js -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const quill = new Quill('#blog-content-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['link', 'image', 'code-block']
                ]
            },
            placeholder: 'Start writing...',
        });

        const contentInput = document.getElementById('content');
        const contentError = document.getElementById('content-error');
        const toggleHtmlBtn = document.getElementById('toggle-html-btn');
        const insertCodeBtn = document.getElementById('insert-code-btn');
        const htmlEditor = document.getElementById('html-code-editor');
        const htmlEditorContainer = document.getElementById('html-editor-container');
        const htmlPreviewContainer = document.getElementById('html-preview-container');
        const htmlPreview = document.getElementById('html-preview');
        const wordCountSpan = document.getElementById('word-count');
        const quillContainer = document.getElementById('quill-container');
        let isHtmlMode = false;

        const updateWordCount = () => {
            const words = quill.getText().trim().split(/\s+/).length || 0;
            wordCountSpan.textContent = `${words} word${words === 1 ? '' : 's'}`;
        };

        const syncContent = () => {
            contentInput.value = isHtmlMode ? htmlEditor.value : quill.root.innerHTML;
            updateWordCount();
            if (quill.getText().trim().length > 0) contentError.classList.add('hidden');
        };

        const updateHtmlPreview = () => {
            htmlPreview.innerHTML = htmlEditor.value || '<p style="color: #9ca3af; font-style: italic;">Preview will appear here...</p>';
        };

        toggleHtmlBtn.addEventListener('click', () => {
            isHtmlMode = !isHtmlMode;
            if (isHtmlMode) {
                htmlEditor.value = quill.root.innerHTML;
                quillContainer.classList.add('hidden');
                htmlEditorContainer.classList.remove('hidden');
                htmlPreviewContainer.classList.remove('hidden');
                toggleHtmlBtn.innerHTML = '<i class="fas fa-edit"></i> Visual Editor';
                toggleHtmlBtn.classList.add('active');
                updateHtmlPreview();
            } else {
                quill.root.innerHTML = htmlEditor.value;
                htmlEditorContainer.classList.add('hidden');
                htmlPreviewContainer.classList.add('hidden');
                quillContainer.classList.remove('hidden');
                toggleHtmlBtn.innerHTML = '<i class="fas fa-code"></i> HTML View';
                toggleHtmlBtn.classList.remove('active');
                syncContent();
            }
        });

        insertCodeBtn.addEventListener('click', () => {
            const code = prompt('Enter your code:');
            if (code) {
                if (isHtmlMode) {
                    htmlEditor.value += `<pre><code>${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>`;
                    updateHtmlPreview();
                } else {
                    const range = quill.getSelection() || { index: quill.getLength() };
                    quill.insertText(range.index, `\n${code}`, 'code-block', true);
                }
                syncContent();
            }
        });

        htmlEditor.addEventListener('input', () => {
            if (isHtmlMode) {
                contentInput.value = htmlEditor.value;
                updateHtmlPreview();
            }
        });

        quill.on('text-change', syncContent);
        updateWordCount();
    });
</script>

<!-- form submit js -->
<script>
    document.getElementById('blog-form').addEventListener('submit', (e) => {
    const textContent = isHtmlMode ? htmlEditor.value.replace(/<[^>]*>/g, '').trim() : quill.getText().trim();
    if (!textContent) {
        e.preventDefault();
        contentError.classList.remove('hidden');
        (isHtmlMode ? htmlEditorContainer : quillContainer).scrollIntoView({ behavior: 'smooth' });
        return;
    }
    const submitBtn = document.querySelector('.btn-primary');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
    submitBtn.disabled = true;
    // Remove simulation and let the form submit naturally
    contentInput.value = isHtmlMode ? htmlEditor.value : quill.root.innerHTML;
    form.submit(); // Trigger actual form submission
});
</script>
{% endblock %}